<!DOCTYPE html>
<html>
<head>
<title>Bookmarks</title>
<meta charset="UTF-8">
</head>
<body>
<style>

body {
	font-family: 'Helvetica', 'Arial', sans-serif;
  color: #444444;
  font-size: 12pt;
}

a:link {text-decoration: none; color: black;}
a:visited {color: black;}
table {
	border: solid black 1px;
	border-spacing: 10px;
	width:700px;
}
table td.like {
	border: solid black 1px;
}
.like_square {
	width:15px;
	height:15px;
	background-color: #8cb8bd;
}
.liked {
	background-color: #f6e8ab;
}
.x {
	width:15px;
	height:15px;
}
.tab {
  background-color: #8cb8bd;
}
    

</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>
(function(){
	init();

  function init() {
		var token = localStorage["lightuponToken"];
		console.log("token")
		console.log(token)
		// TODO: actually make a request to lightupon server using token, and only try to proceed if successful
		if (token) {
	  		getBookmarks(token)
		} else {
			// You fucked up! Go to login!
			window.alert("YA DONE GOOFED! You need to log in. Click ok and you'll be taken straight there.")
			window.location = "/lightupon/login";
		}
  }


  function getBookmarks(token) {
  	 $.ajax({
      method: "GET",
      beforeSend: function (request) {
        request.setRequestHeader("Authorization", "Bearer " + token);
      },
      url:"/lightupon/me/bookmarks"
    }).done(function(response){
    	bookmarksJSON = JSON.parse(response);
    	displayBookmarks(bookmarksJSON)
    });
  }

  function makeLikeOnClickFunction(bookmarkID, likeDiv) {
  	var token = localStorage["lightuponToken"];
  	var bookmarkID = bookmarkID
  	return function(){
  		$.ajax({
		    method: "PUT",
		    url: "/lightupon/bookmarks/" + bookmarkID + "/like",
		    beforeSend: function (request) {
	        request.setRequestHeader("Authorization", "Bearer " + token);
	      },
	      success: function(data, textStatus, xhr) {
					console.log(xhr.status);
  				likeDiv.addClass('liked')
				},
			})
  	};
  }

  function makeFuckThisOnClickFunction(bookmarkID, fuckThisTD) {
    var token = localStorage["lightuponToken"];
    var bookmarkID = bookmarkID
    return function(){
      $.ajax({
        method: "PUT",
        url: "/lightupon/bookmarks/" + bookmarkID + "/fuckThis",
        beforeSend: function (request) {
          request.setRequestHeader("Authorization", "Bearer " + token);
        },
        success: function(data, textStatus, xhr) {
          fuckThisTD.parent().remove(); // remove the whole dern row
        },
      })
    };
  }

  



  function displayBookmarks(bookmarks) {
  	var table = $('<table></table>');

    if(!bookmarks) {alert("No bookmarks returned from the server!")}

  	// For each bookmark we get back, build a tr and stick it on the table
  	for (var i = 0, len = bookmarks.length; i < len; i++) {
  		var bookmark = bookmarks[i];

  		// Start building the "link" td for this row
  		var alreadyLikedString = (bookmark["Liked"] ? " liked" : "");
  		var link = '<a href="' + bookmarks[i]["URL"] + '" target="_blank">' + bookmarks[i]["Title"] + '</a>';
  		var linkTD = $('<td>' + link + '</td>');
  		likeButtonDiv = $('<div class="like_square' + (bookmark["Liked"] ? " liked" : "") + '"></div>');

  		// Start building the "like" td for this row
  		var likeFunction = makeLikeOnClickFunction(bookmark["ID"], likeButtonDiv)
  		likeButtonDiv.on("click", likeFunction);
  		var likeTD = $('<td></td>');
  		likeTD.append(likeButtonDiv);

      // build the "fuck this" button
      var fuckThisTD = $('<td><img class="x" src="https://cdn4.iconfinder.com/data/icons/geomicons/32/672366-x-128.png"/></td>');
      var fuckThisFunction = makeFuckThisOnClickFunction(bookmark["ID"], fuckThisTD)
      fuckThisTD.on("click", fuckThisFunction);


  		// Create the row and append the td's we made
  		var tr = $('<tr></tr>')
  		tr.append(linkTD)
  		tr.append(likeTD)
  		tr.append(fuckThisTD)

  		// Now stick the row on the table
  		table.append(tr)
		}

  	$(".bookmarks").html(table);
  }

})();

</script>

<div>
  <table><tr>
    <td class="tab"><a href="/lightupon/bookmarks/">Feed</a></td>
    <td class="tab"><a href="/lightupon/mycontent/">My Content</a></td>
    <td class="tab"><a href="/lightupon/add_content/">Add A Thing</a></td>
  </tr></table>
  <br>
</div>
<div class="bookmarks">
	things are broke
</div>




</body>
</html>
